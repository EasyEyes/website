<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ffmpeg -->
    <script src="./ffmpeg.min.js"></script>
    <title>EasyEyes FlickeringCSF</title>
    <link rel="stylesheet" href="style.css" />
    <script>
      window.resizeTo(1310, 780);
    </script>
  </head>

  <body>
    <div>
      <video
        id="flickering-video"
        controls
        autoplay
        loop
        playsinline
        muted
      ></video>
    </div>
    <h3><span id="message1"></span></h3>
    <p><span id="message3" hidden></span></p>
    <script src="https://cdn.jsdelivr.net/npm/remote-calibrator@latest"></script>
    <script>
      const message1 = document.getElementById("message3");
      const flickering_video = document.getElementById("flickering-video");
      flickering_video.removeAttribute("controls");

      const isHVC1Supported = MediaSource.isTypeSupported(
        'video/mp4; codecs="hvc1"'
      );
      const isAVC1Supported = MediaSource.isTypeSupported(
        'video/mp4; codecs="avc1.6e0033"'
      );
      RemoteCalibrator.init({ id: "session_022" });
      message3.innerHTML =
        " Browser detected: " + RemoteCalibrator.browser.value;
      const { createFFmpeg, fetchFile } = FFmpeg;
      const ffmpeg = createFFmpeg({ log: true });

      const image2video = async () => {
        // const message = document.getElementById("message");
        // message.innerHTML = "Loading ffmpeg-core.js";
        await ffmpeg.load();
        // message.innerHTML = "Loading data";
        var startTime = performance.now();
        for (let i = 1; i < 5; i += 1) {
          var num = `FlickeringCSF30fps000${i}`;
          ffmpeg.FS(
            "writeFile",
            `tmp${num}.png`,
            await fetchFile(`FlickeringCSF-PNG/${num}.png`)
          );
        }

        if (isHVC1Supported == true) {
          //safari video
          // message0.innerHTML =
          //   "MediaSource.isTypeSupported says that the browser supports the HVC1 (H.265) codec. Using the following configuration: hvc1 compiled using <u>libx265</u> codec with <u>yuv444p10le</u> pixel format, colorprim=bt2020, transfer=linear, colormatrix=bt2020nc.";
          // message1.innerHTML =
          //   "Movie generated by <a target='_blank' href='https://github.com/ffmpegwasm/ffmpeg.wasm'>ffmpeg.wasm</a> from the PNG images using H.265 codec.";
          // // video.src = "Linearity/safari_video.mp4";
          await ffmpeg.run(
            "-pattern_type",
            "glob",
            "-framerate",
            "30",
            "-i",
            "*.png",
            "-tag:v",
            "hvc1",
            "-qp",
            "0",
            "-c:v",
            "libx265",
            "-color_range",
            "tv",
            "-color_trc",
            "linear",
            "-color_primaries",
            "bt2020",
            "-colorspace",
            "bt2020nc",
            "-pix_fmt",
            "yuv444p10le",
            "out.mp4"
          );
        } else if (isAVC1Supported == true) {
          //chrome video
          // message0.innerHTML =
          //   "MediaSource.isTypeSupported says that HVC1 (H.265) codec is not supported by your browser, and AVC1 (H.264) is supported, so using AVC1 (H.264) with the following configuration : avc1 compiled using <u>libx264</u> codec with <u>yuv444p10le</u> pixel format, colorprim=bt2020, transfer=linear, colormatrix=bt2020nc.";
          // message1.innerHTML =
          //   "Movie generated by <a target='_blank' href='https://github.com/ffmpegwasm/ffmpeg.wasm'>ffmpeg.wasm</a> from the PNG images using H.264 codec.";
          // // video.src = "Linearity/chrome_video.mp4";
          await ffmpeg.run(
            "-pattern_type",
            "glob",
            "-framerate",
            "30",
            "-i",
            "*.png",
            "-tag:v",
            "avc1",
            "-c:v",
            "libx264",
            "-qp",
            "0",
            "-color_range",
            "tv",
            "-color_trc",
            "linear",
            "-color_primaries",
            "bt2020",
            "-colorspace",
            "bt2020nc",
            "-pix_fmt",
            "yuv444p10le",
            "out.mp4"
          );
        } else {
          message1.innerHTML =
            "Neither the hvc1 (H.265) nor avc1.6e0033 (H.264) codec is supported by your browser. Please use CHROME or SAFARI ";
        }
        const data = ffmpeg.FS("readFile", "out.mp4");
        for (let i = 1; i < 5; i += 1) {
          var num = `FlickeringCSF30fps000${i}`;
          ffmpeg.FS("unlink", `tmp${num}.png`);
        }
        console.log(data.buffer);
        flickering_video.hidden = false;
        flickering_video.src = URL.createObjectURL(
          new Blob([data.buffer], { type: "video/mp4" })
        );
      };
      flickering_video.removeAttribute("controls");
      window.onload = image2video;
    </script>
  </body>
</html>
